<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta tag para evitar bloqueios de Referer em chaves restritas -->
    <meta name="referrer" content="no-referrer">
    <title>NutriCam Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #fff; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center">

    <div class="w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-6 border border-gray-700">
        <h1 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
            <i class="fas fa-terminal"></i> NutriCam Debugger
        </h1>

        <!-- Passo 1: ConfiguraÃ§Ã£o e Teste -->
        <div class="mb-6">
            <label class="text-xs font-bold text-gray-400 uppercase">1. Sua Nova API Key</label>
            <input type="password" id="apiKey" class="w-full p-3 mt-1 bg-gray-900 border border-gray-600 rounded text-green-400 font-mono text-xs focus:border-blue-500 outline-none transition" placeholder="Cole a chave do NOVO projeto aqui...">
            
            <button onclick="testConnection()" id="btnTest" class="w-full mt-3 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded border border-gray-600 transition">
                ðŸ“¡ Testar ConexÃ£o com Google
            </button>
            
            <div id="connectionStatus" class="mt-2 text-xs font-mono hidden p-2 rounded"></div>
        </div>

        <!-- Passo 2: Upload (SÃ³ aparece se a chave funcionar) -->
        <div id="uploadArea" class="hidden opacity-50 pointer-events-none transition-opacity duration-500">
            <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">2. Enviar Foto</label>
            
            <!-- BotÃ£o Ãšnico e Robusto -->
            <label class="w-full flex flex-col items-center justify-center h-32 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-gray-750 transition bg-gray-900">
                <i class="fas fa-camera text-3xl text-gray-500 mb-2"></i>
                <span class="text-sm text-gray-400">Tocar para abrir CÃ¢mera/Galeria</span>
                <input type="file" class="hidden" accept="image/*" onchange="handleFile(this)">
            </label>

            <!-- Preview -->
            <div id="previewBox" class="hidden mt-4 relative">
                <img id="imgPreview" class="w-full rounded-lg border border-gray-600">
                <button onclick="analyze()" id="btnAnalyze" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition">
                    ðŸš€ Analisar Foto
                </button>
            </div>
        </div>

        <!-- Log de Erros/Sucesso -->
        <div id="consoleLog" class="mt-6 p-3 bg-black rounded border border-gray-800 text-[10px] font-mono text-green-500 h-40 overflow-y-auto hidden">
            > Sistema iniciado...<br>
        </div>
    </div>

    <script>
        // Modelo fixo que funciona 99% das vezes
        const MODEL = 'gemini-1.5-flash'; 
        let base64Data = null;

        function log(msg, type = 'info') {
            const box = document.getElementById('consoleLog');
            box.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-400');
            box.innerHTML += `<span class="${color}">> ${msg}</span><br>`;
            box.scrollTop = box.scrollHeight;
        }

        async function testConnection() {
            const key = document.getElementById('apiKey').value.trim();
            if(key.length < 10) return log("Erro: Chave muito curta.", 'error');

            const btn = document.getElementById('btnTest');
            btn.innerHTML = "â³ Verificando...";
            
            try {
                // Teste simples: Listar modelos. Se isso falhar, a chave Ã© invÃ¡lida para TUDO.
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();

                if(data.error) {
                    throw new Error(data.error.message);
                }

                log("SUCESSO! ConexÃ£o estabelecida.", 'success');
                log(`Encontrados ${data.models?.length || 0} modelos disponÃ­veis.`);
                
                // Libera a Ã¡rea de upload
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.remove('opacity-50', 'pointer-events-none');
                
                document.getElementById('connectionStatus').className = "mt-2 text-xs font-mono p-2 rounded bg-green-900 text-green-200 block";
                document.getElementById('connectionStatus').innerText = "âœ… Chave VÃ¡lida. Pode enviar a foto.";
                btn.innerHTML = "ðŸ“¡ ConexÃ£o OK";

                // Salva a chave
                localStorage.setItem('nutricam_debug_key', key);

            } catch (error) {
                log(`FALHA NA CONEXÃƒO: ${error.message}`, 'error');
                document.getElementById('connectionStatus').className = "mt-2 text-xs font-mono p-2 rounded bg-red-900 text-red-200 block";
                document.getElementById('connectionStatus').innerText = "âŒ Erro: " + error.message;
                btn.innerHTML = "ðŸ“¡ Tentar Novamente";
            }
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;

            log("Lendo imagem...", 'info');
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Data = e.target.result.split(',')[1];
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('previewBox').classList.remove('hidden');
                log("Imagem carregada. Pronta para anÃ¡lise.", 'success');
            };
            reader.readAsDataURL(file);
        }

        async function analyze() {
            const key = document.getElementById('apiKey').value.trim();
            const btn = document.getElementById('btnAnalyze');
            
            btn.disabled = true;
            btn.innerHTML = "â³ Analisando (Aguarde)...";
            log("Enviando requisiÃ§Ã£o para IA...", 'info');

            try {
                const prompt = "Aja como nutricionista esportivo (Homem, 91kg, emagrecimento). Analise a foto: Alimentos, Calorias, ProteÃ­nas. Resuma em tabela.";

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });

                const data = await response.json();

                if(data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                
                // Exibe resultado no lugar do preview
                const resultHTML = marked.parse(text);
                const resultContainer = document.createElement('div');
                resultContainer.className = "prose prose-invert prose-sm mt-4 bg-gray-900 p-4 rounded border border-green-700";
                resultContainer.innerHTML = resultHTML;
                
                document.getElementById('previewBox').appendChild(resultContainer);
                log("ANÃLISE CONCLUÃDA!", 'success');
                btn.innerHTML = "âœ… Feito";

            } catch (error) {
                log(`ERRO NA ANÃLISE: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = "ðŸš€ Tentar Novamente";
                alert("Erro: " + error.message);
            }
        }

        // Auto-load chave salva
        window.onload = () => {
            const savedKey = localStorage.getItem('nutricam_debug_key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
        }
    </script>
</body>
</html>
